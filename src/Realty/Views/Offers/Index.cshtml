@model IEnumerable<Offer>
@{
   var currentUser = ViewBag.CurrentUser;
   var isRealtor = currentUser.IsRealtor;
   var isAdmin = currentUser.IsAdmin;
}

<div class="wrapper wrapper-content animated fadeIn ecommerce">
  <div class="ibox-content m-b-sm border-bottom">
    <span class="text-muted small pull-right">Last modification: <i class="fa fa-clock-o"></i> 2:10 pm - 12/02/2016</span>
    <h2>Offers</h2>
    <p>Contains the list of offers.</p>
  </div>

  <div class="row">
    <div class="col-lg-12">
      <div class="ibox">
        <div class="ibox-content border-bottom">
          <div class="offers-list">
            <ul class="nav nav-tabs">
              @if(isAdmin)
              {
                <span class="pull-right small text-muted">@($"Total offers: {Model.Count()}")</span>
              }

              <li class="active"><a data-toggle="tab" href="#tab-1"><i class="fa fa-handshake-o"></i> All Offers</a></li>
              <li><a data-toggle="tab" href="#tab-2"><i class="fa fa-handshake-o"></i> My Offers</a></li>
              <li><a data-toggle="tab" href="#tab-3"><i class="fa fa-handshake-o"></i> Offers to Me</a></li>
            </ul>

            <div class="tab-content">
              <div id="tab-1" class="tab-pane active">
                <div class="full-height-scroll">
                  <div class="table-responsive">
                    <table class="footable table table-striped table-hover" data-page-size="15">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Listing</th>
                          <th>Status</th>
                          <th>Offer Price</th>
                          <th>Buyer</th>
                          <th>Created</th>
                          <th>Expires</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        @foreach(var offer in Model)
                        {
                          var canSale = isRealtor && offer.Listing.Realtor == currentUser;
                          var canAccept = offer.Listing.Property.Owner == currentUser && !offer.IsExpired &&
                              (offer.Listing.IsInitial || offer.Listing.IsInProgress);
                          var canCancel = offer.Buyer == currentUser && !offer.IsCancelled;
                          <tr>
                            <td>@offer.Id</td>
                            <td>@offer.Listing.Id</td>
                            @if(offer.IsAccepted)
                            {
                              <td class="text-navy font-bold"><i class="fa fa-check"></i> @offer.Status</td>
                            }
                            else
                            {
                              <td>@offer.Status</td>
                            }
                            <td>@offer.OfferPrice.Value.ToString("C")</td>
                            <td>@offer.Buyer.Person.FullName</td>
                            <td>@offer.CreatedAt</td>
                            <td>@offer.ExpiredAt</td>
                            <td style="min-width: 190px;">
                              <form asp-action="Cancel" method="post" asp-route-offerId="@offer.Id">
                                @if(isRealtor || isAdmin)
                                {
                                  @if(offer.IsAccepted && canSale)
                                  {
                                    <a class="btn btn-success btn-xs" asp-controller="Sales" asp-action="New" asp-route-offerId="@offer.Id">New Sale</a>
                                  }
                                  else
                                  {
                                    <a class="btn btn-success btn-xs disabled">New Sale</a>
                                  }
                                }
                                @if(canAccept)
                                {
                                  <a class="btn btn-info btn-xs" asp-action="Accept" asp-route-offerId="@offer.Id">Accept</a>
                                }
                                else
                                {
                                  <a class="btn btn-info btn-xs disabled">Accept</a>
                                }
                                @if(canCancel)
                                {
                                  <button type="submit" class="btn btn-danger btn-xs">Cancel</button>
                                }
                                else
                                {
                                  <a class="btn btn-danger btn-xs disabled">Cancel</a>
                                }
                              </form>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div id="tab-2" class="tab-pane">
                <div class="full-height-scroll">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                      <tr>
                        <th>ID</th>
                        <th>Listing</th>
                        <th>Status</th>
                        <th>Offer Price</th>
                        <th>Buyer</th>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Action</th>
                      </tr>
                      </thead>
                      <tbody>
                      @foreach(var offer in ViewBag.MyOffers)
                      {
                        var canCancel = !offer.IsCancelled;
                        <tr>
                          <td>@offer.Id</td>
                          <td>@offer.Listing.Id</td>
                          @if(offer.IsAccepted)
                          {
                            <td class="text-navy font-bold"><i class="fa fa-check"></i> @offer.Status</td>
                          }
                          else
                          {
                            <td>@offer.Status</td>
                          }
                          <td>@offer.OfferPrice.ToString("C")</td>
                          <td>@offer.Buyer.Person.FullName</td>
                          <td>@offer.CreatedAt</td>
                          <td>@offer.ExpiredAt</td>
                          <td>
                            <form asp-action="Cancel" method="post" asp-route-offerId="@offer.Id">
                              @if(canCancel)
                              {
                                <button type="submit" class="btn btn-danger btn-xs">Cancel</button>
                              }
                              else
                              {
                                <a class="btn btn-danger btn-xs disabled">Cancel</a>
                              }
                            </form>
                          </td>
                        </tr>
                      }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div id="tab-3" class="tab-pane">
                <div class="full-height-scroll">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID</th>
                          <th>Listing</th>
                          <th>Status</th>
                          <th>Offer Price</th>
                          <th>Buyer</th>
                          <th>Created</th>
                          <th>Expires</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        @foreach(var offer in ViewBag.OffersToMe)
                        {
                          var canAccept = offer.Listing.Property.Owner == currentUser && !offer.IsExpired &&
                              (offer.Listing.IsInitial || offer.Listing.IsInProgress);

                          <tr>
                            <td>@offer.Id</td>
                            <td>@offer.Listing.Id</td>
                            @if(offer.IsAccepted)
                            {
                              <td class="text-navy font-bold"><i class="fa fa-check"></i> @offer.Status</td>
                            }
                            else
                            {
                              <td>@offer.Status</td>
                            }
                            <td>@offer.OfferPrice.ToString("C")</td>
                            <td>@offer.Buyer.Person.FullName</td>
                            <td>@offer.CreatedAt</td>
                            <td>@offer.ExpiredAt</td>
                            <td>
                              @if(canAccept)
                              {
                                <a class="btn btn-info btn-xs" asp-action="Accept" asp-route-offerId="@offer.Id">Accept</a>
                              }
                              else
                              {
                                <a class="btn btn-info btn-xs disabled">Accept</a>
                              }
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
